"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(n){var o=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(n);return _possibleConstructorReturn(this,o?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){var n;if(t)return"string"==typeof t?_arrayLikeToArray(t,e):"Map"===(n="Object"===(n=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var o,a,r,i,l=[],s=!0,u=!1;try{if(r=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;s=!1}else for(;!(s=(o=r.call(n)).done)&&(l.push(o.value),l.length!==e);s=!0);}catch(t){u=!0,a=t}finally{try{if(!s&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw a}}return l}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,_toPropertyKey(o.key),o)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var n=t[Symbol.toPrimitive];if(void 0===n)return("string"===e?String:Number)(t);n=n.call(t,e||"default");if("object"!==_typeof(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}var AutoPlay=function(){function s(t,e,n,o,a,r,i){_classCallCheck(this,s);var l=_slicedToArray(r.nextTaskModal.nextTaskCountDownTitle?r.nextTaskModal.nextTaskCountDownTitle.match(/\d+/):"8",1)[0];this.nextTaskId=t,this.nextTaskTitle=e,this.nextTaskDuration=n,this.autoPlayType=o,this.messages=r,this.eventListener=i,this.storageKey="autoplay-timeout",this.nextTaskAlert=null,this.stillHereModal=null,this.canLoadNextTask=!!t,this.stillHereModalTimeout=18e5,this.nextTaskAlertTimeout=1e3*parseInt(l),this.nextTaskCountDownInSeconds=parseInt(l),this.currentTask=a,this.registerComponents()}return _createClass(s,[{key:"hasNextTask",value:function(){return!!this.nextTaskId}},{key:"loadNextTask",value:function(){var t;this.hasNextTask()&&this.canLoadNextTask&&(t=window.location.href.replace(/[0-9]+$/,this.nextTaskId),window.location.href=t)}},{key:"cancelLoadNextTask",value:function(){this.canLoadNextTask=!1,clearTimeout(this.countDownTimeoutId),clearInterval(this.countDownIntervalId),this.timerText.trigger("cancel"),this.nextTaskAlert.close()}},{key:"handleMenuItemsClick",value:function(t,e){var n=this;t.preventDefault(),$(".vjs-autoplay-menu + .vjs-menu .vjs-menu-item.vjs-selected").toggleClass("vjs-selected"),("SPAN"===t.target.tagName?$(t.target).parent():$(t.target)).toggleClass("vjs-selected"),this.eventListener.ga(e,"autoplaychange"),$.post("/user/profile/setAutoPlayType",{autoPlayType:e,taskId:this.currentTask}).done(function(t){return n.updateInfo(e,t)})}},{key:"updateInfo",value:function(t,e){this.cancelLoadNextTask(),this.autoPlayType=t,this.nextTaskId=void 0,this.nextTaskTitle=void 0,this.nextTaskDuration=void 0,"NONE"!==this.autoPlayType&&e&&(this.nextTaskId=e.id,this.nextTaskTitle=e.title,e.duration&&(this.nextTaskDuration=e.duration),t=this.nextTaskTitle,this.nextTaskDuration&&(t=t.concat(" (".concat(this.nextTaskDuration,"min)"))),this.nextTaskButton.controlText(t))}},{key:"buildMenuItems",value:function(t){var n=this,e=videojs.getComponent("MenuItem"),o=this.messages.options,a=o.optionNone,r=o.optionTasks,o=o.optionVideos,a=[new e(t,{label:a,multiSelectable:!1,selectable:!0,selected:"NONE"===this.autoPlayType,autoPlayType:"NONE"}),new e(t,{label:o,multiSelectable:!1,selectable:!0,selected:"VIDEOS"===this.autoPlayType,autoPlayType:"VIDEOS"}),new e(t,{label:r,multiSelectable:!1,selectable:!0,selected:"TASKS"===this.autoPlayType,autoPlayType:"TASKS"})];return a.forEach(function(e){return e.on("click",function(t){n.handleMenuItemsClick(t,e.options_.autoPlayType)})}),a}},{key:"setModalTimeout",value:function(t){var e=(new Date).getTime()+this.stillHereModalTimeout;t.setItem(this.storageKey,e)}},{key:"shouldShowModal",value:function(t){var e=t.getItem(this.storageKey),n=(new Date).getTime();return null===e?(this.setModalTimeout(t),!1):((e=e<n)&&this.setModalTimeout(t),e)}},{key:"_configureEventsOnPlayer",value:function(t,e){var n,o=this;t.on("play",function(){o.canLoadNextTask=o.hasNextTask(),n=setInterval(function(){o.shouldShowModal(e)&&o.stillHereModal.open()},o.stillHereModalTimeout)}),t.on("pause",function(){clearInterval(n)}),t.on("ended",function(){var t,e;o.hasNextTask()&&(o.nextTaskAlert.open(),e=(t=document.querySelector(".border-continue-button")).getTotalLength(),t.style.strokeDasharray=e,t.style.strokeDashoffset=e,o.countDownIntervalId=setInterval(function(){return o.timerText.trigger("countdown")},1e3),o.countDownTimeoutId=setTimeout(function(){o.loadNextTask()},o.nextTaskAlertTimeout))})}},{key:"_buildNextTaskAlert",value:function(t){var e=this,n=this.messages.nextTaskModal,o=n.cancelText,a=n.continueText,n=n.nextTaskModalTitle,n="".concat(n),t=(this.nextTaskAlert=this.buildModal(t,{modalContent:n,modalOptions:{temporary:!1},modalCSSClass:"autoplay-alert",modalEvent:"click",modalEventHandler:function(){}}),this.nextTaskTitle),r=(this.nextTaskDuration&&(t=t.concat(" (".concat(this.nextTaskDuration,"min)"))),this.nextTaskAlert.addChild("Button")),n=(r.countDownTotal=this.nextTaskCountDownInSeconds,r.controlText(this.messages.nextTaskModal.nextTaskCountDownTitle),r.addClass("next-task-timer-text"),r.on("cancel",function(t){r.countDownTotal=e.nextTaskCountDownInSeconds,document.querySelector(".next-task-timer-text .vjs-control-text").innerText=e.messages.nextTaskModal.nextTaskCountDownTitle}),r.on("countdown",function(){--r.countDownTotal,0<r.countDownTotal&&(document.querySelector(".next-task-timer-text .vjs-control-text").innerText=e.messages.nextTaskModal.nextTaskCountDownTitle.replace(/\d+/,r.countDownTotal))}),this.timerText=r,this.nextTaskAlert.addChild("Button")),i=(n.controlText(t),n.addClass("autoplay-nexttask-button"),n.on("click",function(){return e.loadNextTask()}),this.nextTaskButton=n,this.nextTaskAlert.addChild("ClickableComponent")),t=(i.controlText(a),i.addClass("autoplay-continue-button"),i.on("click",function(){return e.loadNextTask()}),fetch("/assets/images/video/autoplay-continue-icon.svg").then(function(t){return t.text()}).then(function(t){return i.el_.children[0].innerHTML=t}),this.nextTaskAlert.addChild("Button"));t.controlText(o),t.addClass("autoplay-cancel-button"),t.on("click",function(){return e.cancelLoadNextTask()})}},{key:"_buildStillHereModal",value:function(t){var e=this.messages.stillHereModal.stillHereModalText;this.stillHereModal=this.buildModal(t,{modalContent:e,modalOptions:{temporary:!1},modalCSSClass:"autoplay-not-watching-alert",modalEvent:"click",modalEventHandler:function(t,e){e.close(),t.focus(),t.play()}}),this.stillHereModal.addChild("BigPlayButton")}},{key:"buildModal",value:function(e,n){var o=e.createModal(n.modalContent,n.modalOptions);return o.close(),o.addClass(n.modalCSSClass),o.on(n.modalEvent,function(t){t.preventDefault(),n.modalEventHandler(e,o,t)}),o}},{key:"registerComponents",value:function(){var e=this,t=videojs.getComponent("MenuButton");videojs.registerComponent("menuAutoPlay",function(){_inherits(o,t);var n=_createSuper(o);function o(t,e){return _classCallCheck(this,o),n.call(this,t,e)}return _createClass(o,[{key:"buildCSSClass",value:function(){return"vjs-autoplay-menu"}},{key:"handleClick",value:function(t){t.preventDefault(),this.player().autoplay(!this.player().autoplay())}},{key:"createItems",value:function(){var t=this.player();t.ready(function(){e.updateAutoplayMenu(t),e.shouldShowModal(localStorage),e._buildStillHereModal(t),e._buildNextTaskAlert(t),e._configureEventsOnPlayer(t,localStorage)})}}]),o}())}},{key:"updateAutoplayMenu",value:function(t){var e=this,n=t.controlBar.getChild("menuAutoPlay");n.createItems=function(){return e.buildMenuItems(t)},n.update()}}]),s}();